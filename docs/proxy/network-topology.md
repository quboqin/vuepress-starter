# å®¶åº­ç½‘ç»œæ‹“æ‰‘ä¸æ—è·¯ç”±é…ç½®

## ç›®å½•
- [å®¶åº­ç½‘ç»œåŸºç¡€æ¦‚å¿µ](#å®¶åº­ç½‘ç»œåŸºç¡€æ¦‚å¿µ)
- [ç½‘ç»œæ‹“æ‰‘æ–¹æ¡ˆå¯¹æ¯”](#ç½‘ç»œæ‹“æ‰‘æ–¹æ¡ˆå¯¹æ¯”)
- [ä¸»è·¯ç”± vs æ—è·¯ç”±](#ä¸»è·¯ç”±-vs-æ—è·¯ç”±)
- [æ—è·¯ç”±è¯¦ç»†é…ç½®](#æ—è·¯ç”±è¯¦ç»†é…ç½®)
- [PVE+OpenWrtç½‘ç»œæ‹“æ‰‘å®æˆ˜](#pveopenwrtç½‘ç»œæ‹“æ‰‘å®æˆ˜)
- [å¸¸è§é—®é¢˜ä¸æ’æŸ¥](#å¸¸è§é—®é¢˜ä¸æ’æŸ¥)

---

## å®¶åº­ç½‘ç»œåŸºç¡€æ¦‚å¿µ

### ç½‘ç»œè®¾å¤‡è§’è‰²

```
å®¶åº­ç½‘ç»œåŸºæœ¬æ¶æ„ï¼š

å…¥æˆ·å…‰çº¤
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å…‰çŒ«      â”‚  â”Œâ”€ å…‰ç”µè½¬æ¢
â”‚  192.168.1.1  â”‚  â”œâ”€ æ‹¨å·ï¼ˆPPPoEï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€ è·¯ç”±/NAT
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                      â”‚
       â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸»è·¯ç”±å™¨ â”‚          â”‚  IPTV    â”‚
â”‚(WiFiè¦†ç›–)â”‚          â”‚  æœºé¡¶ç›’   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚        â”‚        â”‚
     â–¼        â–¼        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”µè„‘   â”‚ â”‚  æ‰‹æœº   â”‚ â”‚  NAS   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ç½‘ç»œæ¦‚å¿µ

| æ¦‚å¿µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **ç½‘å…³(Gateway)** | ç½‘ç»œçš„å‡ºå£ | 192.168.1.1 |
| **å­ç½‘æ©ç ** | å®šä¹‰ç½‘ç»œèŒƒå›´ | 255.255.255.0 |
| **DHCP** | è‡ªåŠ¨åˆ†é…IP | 192.168.1.100-200 |
| **DNS** | åŸŸåè§£æ | 223.5.5.5 |
| **NAT** | åœ°å€è½¬æ¢ | å†…ç½‘è½¬å…¬ç½‘ |

---

## ç½‘ç»œæ‹“æ‰‘æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆä¸€ï¼šå…‰çŒ«æ‹¨å·ï¼ˆåŸºç¡€ç‰ˆï¼‰

```
å…‰çŒ«(æ‹¨å·+è·¯ç”±)
    â”‚
    â”œâ”€â”€ è·¯ç”±å™¨(APæ¨¡å¼/WiFi)
    â”œâ”€â”€ ç”µè„‘
    â””â”€â”€ æ‰‹æœº
```

**ä¼˜ç‚¹**: ç®€å•ï¼Œè¿è¥å•†ç»´æŠ¤
**ç¼ºç‚¹**: å…‰çŒ«æ€§èƒ½å¼±ï¼ŒåŠŸèƒ½å—é™

---

### æ–¹æ¡ˆäºŒï¼šè·¯ç”±å™¨æ‹¨å·ï¼ˆä¸»æµç‰ˆï¼‰

```
å…‰çŒ«(æ¡¥æ¥) â”€â”€ è·¯ç”±å™¨(æ‹¨å·+è·¯ç”±+WiFi)
                    â”‚
                    â”œâ”€â”€ ç”µè„‘
                    â”œâ”€â”€ æ‰‹æœº
                    â””â”€â”€ NAS
```

**ä¼˜ç‚¹**: æ€§èƒ½å¥½ï¼ŒåŠŸèƒ½å¤š
**ç¼ºç‚¹**: å•ç‚¹æ•…éšœ

---

### æ–¹æ¡ˆä¸‰ï¼šè½¯è·¯ç”±ä¸»è·¯ç”±ï¼ˆAll in Oneï¼‰

```
å…‰çŒ«(æ¡¥æ¥) â”€â”€ è½¯è·¯ç”±(ä¸»è·¯ç”±+ç§‘å­¦ä¸Šç½‘)
                    â”‚
                    â”œâ”€â”€ AP (çº¯WiFi)
                    â”œâ”€â”€ ç”µè„‘
                    â””â”€â”€ æ‰‹æœº
```

**ä¼˜ç‚¹**: åŠŸèƒ½å¼ºå¤§ï¼Œå…¨å±‹ç§‘å­¦ä¸Šç½‘
**ç¼ºç‚¹**: è½¯è·¯ç”±æ•…éšœå…¨å®¶æ–­ç½‘

---

### æ–¹æ¡ˆå››ï¼šæ—è·¯ç”±æ–¹æ¡ˆï¼ˆæ¨èï¼‰

```
å…‰çŒ«/ä¸»è·¯ç”±(æ‹¨å·)
    â”‚
    â”œâ”€â”€ ç”µè„‘ â”€â”€â”€â”€â”€â”€â”
    â”œâ”€â”€ æ‰‹æœº       â”‚
    â”‚              â”‚
    â””â”€â”€ æ—è·¯ç”± â”€â”€â”€â”€â”˜
        (ç§‘å­¦ä¸Šç½‘)
```

**ä¼˜ç‚¹**: 
- ä¸»è·¯ç”±ç¨³å®šï¼Œä¸æ”¹åŠ¨ç°æœ‰ç½‘ç»œ
- æ—è·¯ç”±æ•…éšœä¸å½±å“å…¶ä»–è®¾å¤‡
- çµæ´»é€‰æ‹©å“ªäº›è®¾å¤‡èµ°ä»£ç†

**ç¼ºç‚¹**: 
- éœ€è¦æ‰‹åŠ¨é…ç½®ç½‘å…³
- å¤šä¸€å±‚NATï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

---

## ä¸»è·¯ç”± vs æ—è·¯ç”±

### è§’è‰²å¯¹æ¯”

| åŠŸèƒ½ | ä¸»è·¯ç”± | æ—è·¯ç”± |
|------|--------|--------|
| **æ‹¨å·ä¸Šç½‘** | âœ… å¿…é¡» | âŒ ä¸éœ€è¦ |
| **DHCPæœåŠ¡** | âœ… ä¸»è¦ | âŒ å…³é—­ |
| **NATè½¬å‘** | âœ… å¿…é¡» | âœ… å¯é€‰ |
| **ç§‘å­¦ä¸Šç½‘** | âœ… å¯ä»¥ | âœ… ä¸“é—¨ |
| **ç¨³å®šæ€§è¦æ±‚** | ğŸ”´ æé«˜ | ğŸŸ¡ é«˜ |
| **æ•…éšœå½±å“** | å…¨å±‹æ–­ç½‘ | ä»…ä»£ç†è®¾å¤‡ |

### é€‰æ‹©å»ºè®®

```
ä½¿ç”¨åœºæ™¯æ¨èï¼š

è¿½æ±‚ç®€å•ç¨³å®š â†’ ä¸»è·¯ç”±æ–¹æ¡ˆ
â”œâ”€â”€ ä¸»è·¯ç”±: ç¡¬è·¯ç”±(åç¡•/å°ç±³ç­‰)
â””â”€â”€ ä¸»è·¯ç”±: è½¯è·¯ç”±(OpenWrt)

è¿½æ±‚çµæ´»å¯æ§ â†’ æ—è·¯ç”±æ–¹æ¡ˆ
â”œâ”€â”€ ä¸»è·¯ç”±: ç¡¬è·¯ç”±/å…‰çŒ«
â””â”€â”€ æ—è·¯ç”±: è½¯è·¯ç”±(OpenWrt)

æŠ€æœ¯çˆ±å¥½è€… â†’ All in One
â”œâ”€â”€ PVEè™šæ‹ŸåŒ–
â”œâ”€â”€ ä¸»è·¯ç”±: OpenWrtè™šæ‹Ÿæœº
â””â”€â”€ æ—è·¯ç”±: åŒä¸ªOpenWrtæˆ–å¦ä¸€ä¸ªVM
```

---

## æ—è·¯ç”±è¯¦ç»†é…ç½®

### ç½‘ç»œå‚æ•°è§„åˆ’

```
ç½‘ç»œè§„åˆ’ç¤ºä¾‹ï¼š

å­ç½‘: 192.168.2.0/24

è®¾å¤‡IPåˆ†é…ï¼š
â”œâ”€â”€ ä¸»è·¯ç”±: 192.168.2.1
â”œâ”€â”€ æ—è·¯ç”±: 192.168.2.2
â”œâ”€â”€ PVEç®¡ç†: 192.168.2.100
â”œâ”€â”€ APç®¡ç†: 192.168.2.10
â”œâ”€â”€ NAS: 192.168.2.50
â””â”€â”€ DHCPæ± : 192.168.2.101-200
```

### ä¸»è·¯ç”±å™¨é…ç½®

#### æ–¹æ¡ˆAï¼šç½‘å…³æŒ‡å‘æ—è·¯ç”±ï¼ˆå…¨å±€ä»£ç†ï¼‰

**DHCPè®¾ç½®**ï¼š
```
ä¸»è·¯ç”±DHCPé…ç½®ï¼š
â”œâ”€â”€ DHCPæœåŠ¡å™¨: å¯ç”¨
â”œâ”€â”€ ç½‘å…³: 192.168.2.2 (æŒ‡å‘æ—è·¯ç”±)
â”œâ”€â”€ DNS: 192.168.2.2 (æŒ‡å‘æ—è·¯ç”±)
â””â”€â”€ IPèŒƒå›´: 192.168.2.101-200
```

**ä¼˜ç‚¹**: æ‰€æœ‰è®¾å¤‡è‡ªåŠ¨èµ°ä»£ç†
**ç¼ºç‚¹**: æ—è·¯ç”±æ•…éšœï¼Œæ‰€æœ‰è®¾å¤‡æ–­ç½‘

#### æ–¹æ¡ˆBï¼šä¿æŒé»˜è®¤ï¼ˆæŒ‰éœ€ä»£ç†ï¼‰

**DHCPè®¾ç½®**ï¼š
```
ä¸»è·¯ç”±DHCPé…ç½®ï¼š
â”œâ”€â”€ DHCPæœåŠ¡å™¨: å¯ç”¨
â”œâ”€â”€ ç½‘å…³: 192.168.2.1 (ä¸»è·¯ç”±è‡ªå·±)
â”œâ”€â”€ DNS: 223.5.5.5 (æˆ–ä¸»è·¯ç”±)
â””â”€â”€ IPèŒƒå›´: 192.168.2.101-200
```

**éœ€è¦ä»£ç†çš„è®¾å¤‡**: æ‰‹åŠ¨è®¾ç½®ç½‘å…³ä¸º192.168.2.2

**ä¼˜ç‚¹**: æ—è·¯ç”±æ•…éšœä¸å½±å“å…¶ä»–è®¾å¤‡
**ç¼ºç‚¹**: éœ€è¦æ‰‹åŠ¨é…ç½®æ¯å°è®¾å¤‡

### æ—è·¯ç”±OpenWrté…ç½®

#### 1. ç½‘ç»œåŸºæœ¬è®¾ç½®

```bash
# ä¿®æ”¹LANå£IP
uci set network.lan.ipaddr='192.168.2.2'
uci set network.lan.netmask='255.255.255.0'

# è®¾ç½®ç½‘å…³æŒ‡å‘ä¸»è·¯ç”±
uci set network.lan.gateway='192.168.2.1'

# è®¾ç½®DNS
uci set network.lan.dns='223.5.5.5'

uci commit network
```

#### 2. å…³é—­DHCP

```bash
# å…³é—­DHCPæœåŠ¡å™¨
uci set dhcp.lan.ignore='1'

# å…³é—­IPv6 DHCPï¼ˆå¯é€‰ï¼‰
uci set dhcp.lan.ra='disabled'
uci set dhcp.lan.dhcpv6='disabled'

uci commit dhcp
```

#### 3. é˜²ç«å¢™è®¾ç½®

```bash
# æ–¹æ¡ˆ1ï¼šå…è®¸æ‰€æœ‰è¾“å…¥ï¼ˆç®€å•ä½†å®‰å…¨æ€§è¾ƒä½ï¼‰
uci set firewall.@zone[0].input='ACCEPT'
uci commit firewall
/etc/init.d/firewall restart

# æ–¹æ¡ˆ2ï¼šæ·»åŠ ç‰¹å®šè§„åˆ™ï¼ˆæ¨èï¼‰
# å…è®¸ç‰¹å®šç«¯å£
uci add firewall rule
uci set firewall.@rule[-1].name='Allow-Proxy'
uci set firewall.@rule[-1].src='lan'
uci set firewall.@rule[-1].dest_port='ä½ çš„ä»£ç†ç«¯å£'
uci set firewall.@rule[-1].proto='tcp udp'
uci set firewall.@rule[-1].target='ACCEPT'

uci commit firewall
/etc/init.d/firewall restart
```

#### 4. IPåŠ¨æ€ä¼ªè£…ï¼ˆå¯é€‰ï¼‰

å¦‚æœä¸è®¾ç½®ï¼Œè¿”å›çš„æµé‡ä¼šç»è¿‡ä¸»è·¯ç”±å†åˆ°è®¾å¤‡ã€‚

```bash
# å¼€å¯IPä¼ªè£…ï¼ˆSNATï¼‰
uci set firewall.@zone[0].masq='1'
uci commit firewall
/etc/init.d/firewall restart
```

**å¼€å¯masq**: æ—è·¯ç”±ç›´æ¥è¿”å›æµé‡ï¼Œæ•ˆç‡æ›´é«˜
**å…³é—­masq**: æµé‡è¿”å›ä¸»è·¯ç”±å†åˆ°è®¾å¤‡ï¼Œæ›´ç¬¦åˆæ ‡å‡†ç½‘ç»œæµç¨‹

#### 5. DNSåŠ«æŒï¼ˆæ¨èï¼‰

```bash
# å®‰è£…dnsmasq-fullï¼ˆå¦‚æœè¿˜æ²¡å®‰è£…ï¼‰
opkg update
opkg install dnsmasq-full

# é…ç½®DNSåŠ«æŒ
uci set dhcp.@dnsmasq[0].noresolv='1'
uci add_list dhcp.@dnsmasq[0].server='223.5.5.5'
uci add_list dhcp.@dnsmasq[0].server='8.8.8.8'

uci commit dhcp
/etc/init.d/dnsmasq restart
```

### å®Œæ•´é…ç½®è„šæœ¬

```bash
#!/bin/sh
# OpenWrtæ—è·¯ç”±ä¸€é”®é…ç½®è„šæœ¬
# è¯·æ ¹æ®å®é™…ç½‘ç»œä¿®æ”¹IPåœ°å€

# ===== é…ç½®åŒºåŸŸ =====
MAIN_ROUTER_IP="192.168.2.1"
OPENWRT_IP="192.168.2.2"
DNS_SERVER="223.5.5.5"
# ===================

echo "å¼€å§‹é…ç½®OpenWrtæ—è·¯ç”±..."

# 1. è®¾ç½®LANå£
uci set network.lan.ipaddr="$OPENWRT_IP"
uci set network.lan.netmask='255.255.255.0'
uci set network.lan.gateway="$MAIN_ROUTER_IP"
uci set network.lan.dns="$DNS_SERVER"

# 2. å…³é—­DHCP
uci set dhcp.lan.ignore='1'
uci set dhcp.lan.ra='disabled'
uci set dhcp.lan.dhcpv6='disabled'

# 3. é˜²ç«å¢™è®¾ç½®
uci set firewall.@zone[0].input='ACCEPT'
uci set firewall.@zone[0].forward='ACCEPT'

# 4. æäº¤é…ç½®
uci commit network
uci commit dhcp
uci commit firewall

echo "é…ç½®å®Œæˆï¼"
echo "OpenWrt IP: $OPENWRT_IP"
echo "è¯·é‡å¯ç½‘ç»œæœåŠ¡: /etc/init.d/network restart"
```

---

## PVE+OpenWrtç½‘ç»œæ‹“æ‰‘å®æˆ˜

### å®Œæ•´æ‹“æ‰‘å›¾

```
                              äº’è”ç½‘
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å…‰çŒ«/ä¸»è·¯ç”±å™¨                          â”‚
â”‚                     192.168.2.1/24                          â”‚
â”‚                         æ‹¨å·ä¸Šç½‘                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ ç½‘çº¿è¿æ¥åˆ°PVEä¸»æœºeth0
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PVEä¸»æœº (192.168.2.100)                   â”‚
â”‚                CPU: i5-4300U / å†…å­˜: 8GB                     â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  Linux Bridge (vmbr0)                  â”‚ â”‚
â”‚  â”‚         æ¡¥æ¥eth0ï¼Œè¿æ¥ä¸»è·¯ç”±                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      â–¼                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚           OpenWrt æ—è·¯ç”± (VM ID: 100)            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   eth0      â”‚â”€â”€â”€â”€â”€â”€â”‚      vmbr0          â”‚â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¤
â”‚  â”‚  â”‚  â”‚   LAN       â”‚      â”‚  192.168.2.2/24     â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  ç½‘å…³: 192.168.2.1  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚         ç§‘å­¦ä¸Šç½‘æ’ä»¶                     â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚Passwall â”‚ â”‚OpenClashâ”‚ â”‚ SSR+    â”‚   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚           NASæœåŠ¡å™¨ (VM ID: 101)                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           TrueNAS/OMV                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           192.168.2.50                          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚           Home Assistant (VM ID: 102)            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           æ™ºèƒ½å®¶å±…æ§åˆ¶ä¸­å¿ƒ                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚           192.168.2.51                          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                    â”‚                    â”‚
       â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”µè„‘A   â”‚        â”‚   æ‰‹æœº    â”‚        â”‚   ç”µè§†    â”‚
â”‚æ‰‹åŠ¨è®¾ç½®ç½‘å…³â”‚        â”‚DHCPé»˜è®¤  â”‚        â”‚DHCPé»˜è®¤  â”‚
â”‚192.168.2.2â”‚        â”‚192.168.2.1â”‚        â”‚192.168.2.1â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   èµ°ä»£ç†               ç›´è¿               ç›´è¿
```

### é…ç½®è¯´æ˜

**è®¾å¤‡é€‰æ‹©ä»£ç†æ–¹å¼**ï¼š

| è®¾å¤‡ | IPè·å– | ç½‘å…³è®¾ç½® | è¯´æ˜ |
|------|--------|----------|------|
| **ç”µè„‘A** | DHCP | æ‰‹åŠ¨192.168.2.2 | å…¨å±€èµ°ä»£ç† |
| **ç”µè„‘B** | DHCP | é»˜è®¤192.168.2.1 | å›½å†…ç›´è¿ |
| **æ‰‹æœº** | DHCP | é»˜è®¤192.168.2.1 | å›½å†…ç›´è¿ |
| **ç”µè§†** | DHCP | é»˜è®¤192.168.2.1 | å›½å†…ç›´è¿ |
| **NAS** | é™æ€ | é»˜è®¤192.168.2.1 | æœåŠ¡ç›´è¿ |

### PVEç½‘ç»œé…ç½®

#### å•ç½‘å£æ–¹æ¡ˆï¼ˆå•è‡‚è·¯ç”±ï¼‰

```bash
# /etc/network/interfaces

auto lo
iface lo inet loopback

# ç®¡ç†ç½‘æ¡¥ï¼ˆè¿æ¥ä¸»è·¯ç”±ï¼‰
auto vmbr0
iface vmbr0 inet static
    address 192.168.2.100/24
    gateway 192.168.2.1
    bridge-ports eth0
    bridge-stp off
    bridge-fd 0
```

#### åŒç½‘å£æ–¹æ¡ˆï¼ˆæ¨èï¼‰

```bash
# /etc/network/interfaces

auto lo
iface lo inet loopback

# ç®¡ç†ç½‘æ¡¥ï¼ˆeth0è¿æ¥ä¸»è·¯ç”±ï¼‰
auto vmbr0
iface vmbr0 inet static
    address 192.168.2.100/24
    gateway 192.168.2.1
    bridge-ports eth0
    bridge-stp off
    bridge-fd 0

# OpenWrt WANå£ï¼ˆeth1ï¼Œå¯é€‰ï¼‰
auto vmbr1
iface vmbr1 inet manual
    bridge-ports eth1
    bridge-stp off
    bridge-fd 0
```

#### å››ç½‘å£æ–¹æ¡ˆï¼ˆå®Œæ•´è½¯è·¯ç”±ï¼‰

```bash
# /etc/network/interfaces

auto lo
iface lo inet loopback

# ç®¡ç†/PVEè®¿é—®
auto vmbr0
iface vmbr0 inet static
    address 192.168.2.100/24
    gateway 192.168.2.1
    bridge-ports eth0
    bridge-stp off
    bridge-fd 0

# WANå£ï¼ˆç›´é€šç»™OpenWrtï¼‰
auto vmbr1
iface vmbr1 inet manual
    bridge-ports eth1
    bridge-stp off
    bridge-fd 0

# LAN1ï¼ˆç›´é€šç»™OpenWrtï¼‰
auto vmbr2
iface vmbr2 inet manual
    bridge-ports eth2
    bridge-stp off
    bridge-fd 0

# LAN2ï¼ˆç›´é€šç»™OpenWrtï¼‰
auto vmbr3
iface vmbr3 inet manual
    bridge-ports eth3
    bridge-stp off
    bridge-fd 0
```

### OpenWrtè™šæ‹Ÿæœºé…ç½®

**è™šæ‹Ÿæœºé…ç½®ï¼ˆæ—è·¯ç”±æ¨¡å¼ï¼‰**ï¼š

| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| VM ID | 100 |
| å†…å­˜ | 1GB |
| CPU | 2æ ¸ |
| ç¡¬ç›˜ | 1GB |
| ç½‘å¡1 | vmbr0 (LAN) |

**OpenWrtç½‘ç»œé…ç½®**ï¼š
```bash
# LANå£é…ç½®
uci set network.lan.proto='static'
uci set network.lan.ipaddr='192.168.2.2'
uci set network.lan.netmask='255.255.255.0'
uci set network.lan.gateway='192.168.2.1'
uci set network.lan.dns='223.5.5.5'

# å…³é—­DHCP
uci set dhcp.lan.ignore='1'
uci commit
```

---

## å¸¸è§é—®é¢˜ä¸æ’æŸ¥

### é—®é¢˜1ï¼šè®¾å¤‡æ— æ³•è®¿é—®æ—è·¯ç”±

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æ£€æŸ¥æ—è·¯ç”±IP
ip addr show br-lan

# 2. æ£€æŸ¥é˜²ç«å¢™
iptables -L -n | grep INPUT

# 3. æµ‹è¯•è¿é€šæ€§
ping 192.168.2.2

# 4. æ£€æŸ¥ä¸»è·¯ç”±åˆ°æ—è·¯ç”±
åœ¨ä¸»è·¯ç”±ä¸Š: ping 192.168.2.2
```

### é—®é¢˜2ï¼šè®¾ç½®äº†æ—è·¯ç”±ç½‘å…³ä½†æ— æ³•ä¸Šç½‘

**å¯èƒ½åŸå› **ï¼š
1. æ—è·¯ç”±æ²¡æœ‰å¼€å¯IPä¼ªè£…
2. ç§‘å­¦ä¸Šç½‘æ’ä»¶æœªè¿è¡Œ
3. DNSè§£æå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¼€å¯IPä¼ªè£…
uci set firewall.@zone[0].masq='1'
uci commit firewall
/etc/init.d/firewall restart

# æ£€æŸ¥ä»£ç†æœåŠ¡çŠ¶æ€
/etc/init.d/passwall status
/etc/init.d/openclash status
```

### é—®é¢˜3ï¼šéƒ¨åˆ†ç½‘ç«™è®¿é—®æ…¢

**åŸå› **ï¼šDNSè§£ææˆ–åˆ†æµè§„åˆ™é—®é¢˜

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```bash
# é…ç½®SmartDNS
uci set smartdns.@smartdns[0].enabled='1'
uci set smartdns.@smartdns[0].port='6053'
uci commit smartdns

# è®©dnsmasqä½¿ç”¨SmartDNS
uci set dhcp.@dnsmasq[0].local='6053'
uci commit dhcp
```

### é—®é¢˜4ï¼šæ—è·¯ç”±æ•…éšœå¯¼è‡´éƒ¨åˆ†è®¾å¤‡æ–­ç½‘

**å¿«é€Ÿæ¢å¤**ï¼š
```bash
# åœ¨æ—è·¯ç”±ä¸Šæ‰§è¡Œï¼Œæ¢å¤åˆ°ç›´è¿çŠ¶æ€
uci delete network.lan.gateway
uci commit network
/etc/init.d/network restart

# æˆ–è€…ä¸´æ—¶å…³é—­æ—è·¯ç”±ï¼Œè®¾å¤‡ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸»è·¯ç”±
```

---

## æœ€ä½³å®è·µ

### 1. ç½‘å…³è®¾ç½®ç­–ç•¥

```
æ¨èæ–¹æ¡ˆï¼š
â”œâ”€â”€ ä¸»è·¯ç”±DHCPé»˜è®¤ç½‘å…³æŒ‡å‘ä¸»è·¯ç”±è‡ªå·±
â”œâ”€â”€ éœ€è¦ä»£ç†çš„è®¾å¤‡ï¼šæ‰‹åŠ¨/é™æ€IPï¼Œç½‘å…³æŒ‡å‘æ—è·¯ç”±
â””â”€â”€ ä¸éœ€è¦ä»£ç†çš„è®¾å¤‡ï¼šè‡ªåŠ¨è·å–ï¼Œç›´è¿

å¯é€‰æ–¹æ¡ˆï¼š
â”œâ”€â”€ ä¸»è·¯ç”±DHCPç½‘å…³æŒ‡å‘æ—è·¯ç”±ï¼ˆå…¨å±‹ä»£ç†ï¼‰
â””â”€â”€ ç‰¹æ®Šè®¾å¤‡æ‰‹åŠ¨è®¾ç½®ç½‘å…³æŒ‡å‘ä¸»è·¯ç”±ï¼ˆç›´è¿ï¼‰
```

### 2. IPåœ°å€è§„åˆ’

```
å»ºè®®åœ°å€æ®µï¼š
â”œâ”€â”€ ä¸»è·¯ç”±: xxx.xxx.xxx.1
â”œâ”€â”€ æ—è·¯ç”±: xxx.xxx.xxx.2
â”œâ”€â”€ PVE/NAS: xxx.xxx.xxx.10-50 (æœåŠ¡å™¨)
â””â”€â”€ DHCPæ± : xxx.xxx.xxx.100-200 (å®¢æˆ·ç«¯)
```

### 3. å¤‡ä»½ç­–ç•¥

```bash
# OpenWrté…ç½®å¤‡ä»½
uci export > /root/openwrt-backup.txt

# æˆ–è€…ä½¿ç”¨sysupgradeå¤‡ä»½
sysupgrade -b /root/backup.tar.gz

# å®šæœŸå¤‡ä»½åˆ°è¿œç¨‹
scp /root/backup.tar.gz user@nas:/backup/
```

---

**æœ€åæ›´æ–°**: 2026å¹´2æœˆ
