# X86 平台 OpenWRT 安装与配置

## 概述

X86 平台的 OpenWRT 具有强大的硬件性能和高度的可定制性，适合构建高性能软路由系统。支持虚拟化环境（如 PVE）和物理机直接安装。

## 硬件要求

### 最低配置
- **CPU**: 双核 x86_64 处理器
- **内存**: 2GB RAM
- **存储**: 8GB SSD/HDD
- **网络**: 至少 1 个网口

### 推荐配置
- **CPU**: 四核以上 Intel/AMD 处理器
- **内存**: 4GB+ RAM
- **存储**: 32GB+ SSD
- **网络**: 2+ 千兆网口
- **其他**: 支持虚拟化技术（VT-x/AMD-V）

## 固件下载

### 推荐固件源

1. **恩山论坛固件**
   - [【2022-5-14】每日更新 高大全/精简版 Openwrt x86 5.15内核](https://www.right.com.cn/forum/thread-7048868-1-1.html)

2. **GitHub Actions 自动构建**
   - [FusionWRT_x86_x64](https://github.com/quboqin/FusionWRT_x86_x64)

### 固件信息

- **管理地址**: 192.168.1.1
- **默认账号**: root
- **默认密码**: password
- **内置插件**:
  - Passwall/Hello World/OpenClash
  - UU游戏加速器
  - DDNS
  - iperf3 测速
  - Docker 支持

### 固件格式说明

| 格式 | 描述 | 适用场景 |
|------|------|----------|
| **combined-squashfs.img.gz** | 压缩的完整镜像 | 物理机安装 |
| **combined-ext4.img.gz** | ext4 文件系统镜像 | 高级用户使用 |
| **rootfs-squashfs.img.gz** | 仅根文件系统 | 虚拟化环境 |
| **generic-kernel.bin** | 内核文件 | 特殊需求 |

## 物理机安装

### 制作启动盘

#### Windows 环境

1. **下载工具**
   - [Rufus](https://rufus.ie/) 或 [balenaEtcher](https://www.balena.io/etcher/)

2. **制作步骤**
   ```bash
   # 解压固件（如需要）
   7z x openwrt-x86-64-combined-squashfs.img.gz

   # 使用 Rufus 写入 U 盘
   # 选择镜像文件和目标 U 盘
   # 点击"开始"写入
   ```

#### Linux 环境

```bash
# 解压固件
gunzip openwrt-x86-64-combined-squashfs.img.gz

# 查看磁盘设备
lsblk

# 写入 U 盘（注意替换 /dev/sdX）
sudo dd if=openwrt-x86-64-combined-squashfs.img of=/dev/sdX bs=4M status=progress
sync
```

### BIOS/UEFI 设置

1. **启动顺序**
   - 设置 U 盘为第一启动项
   - 或选择 UEFI 模式启动

2. **其他设置**
   - 开启虚拟化支持（如需要）
   - 禁用 Secure Boot
   - 设置网卡启动顺序

## PVE 虚拟化安装

### 导入镜像

```bash
# 上传固件到 PVE
scp openwrt-x86-64-combined-squashfs.img.gz root@pve-server:/var/lib/vz/template/iso/

# SSH 登录 PVE
ssh root@pve-server

# 解压固件
cd /var/lib/vz/template/iso/
gunzip openwrt-x86-64-combined-squashfs.img.gz

# 导入磁盘（VM ID 100）
qm importdisk 100 openwrt-x86-64-combined-squashfs.img local-lvm
```

### 创建虚拟机

1. **基本配置**
   - VM ID: 100
   - Name: OpenWrt
   - OS Type: Linux 6.x - 2.6 Kernel

2. **硬件配置**
   - CPU: 2 cores
   - Memory: 2048MB
   - Network: 2x VirtIO (WAN/LAN)
   - Disk: 使用导入的磁盘

3. **网络配置**
   - WAN: 桥接到 vmbr0
   - LAN: 桥接到 vmbr1（内网）

### 虚拟机优化

```bash
# 启用 QEMU Guest Agent
qm set 100 --agent enabled=1

# 设置 CPU 类型
qm set 100 --cpu host

# 调整内存
qm set 100 --memory 4096 --balloon 2048
```

## 初始配置

### 网络配置

#### 单臂路由配置

```bash
# 编辑网络配置
vi /etc/config/network

# LAN 接口配置
config interface 'lan'
    option ifname 'eth0'
    option proto 'static'
    option ipaddr '192.168.1.1'
    option netmask '255.255.255.0'
    option ip6assign '60'
```

#### 双网口配置

```bash
# WAN 接口
config interface 'wan'
    option ifname 'eth0'
    option proto 'dhcp'  # 或 'pppoe'

# LAN 接口
config interface 'lan'
    option ifname 'eth1'
    option proto 'static'
    option ipaddr '192.168.1.1'
    option netmask '255.255.255.0'
```

### SSH 访问

```bash
# 启用 SSH
/etc/init.d/dropbear enable
/etc/init.d/dropbear start

# 设置 root 密码
passwd root

# 添加 SSH 密钥（推荐）
mkdir -p /root/.ssh
vi /root/.ssh/authorized_keys
```

## 性能优化

### SMP Affinity 优化

```bash
# 查看中断分布
cat /proc/interrupts

# 设置网卡中断绑定到特定 CPU
echo 2 > /proc/irq/24/smp_affinity
echo 4 > /proc/irq/25/smp_affinity
```

### 内核参数调优

```bash
# 编辑 sysctl 配置
vi /etc/sysctl.conf

# 添加优化参数
net.core.netdev_max_backlog = 5000
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 65536 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.netfilter.nf_conntrack_max = 65536
```

### 存储优化

```bash
# 启用 SSD TRIM
echo 'fstrim -av' >> /etc/crontabs/root

# 调整文件系统挂载参数
vi /etc/config/fstab
```

## 扩展功能

### Docker 支持

```bash
# 安装 Docker
opkg update
opkg install docker dockerd

# 启用 Docker 服务
/etc/init.d/dockerd enable
/etc/init.d/dockerd start

# 验证安装
docker version
```

### KVM 嵌套虚拟化

```bash
# 检查支持情况
cat /proc/cpuinfo | grep -E "(vmx|svm)"

# 加载 KVM 模块
modprobe kvm-intel  # Intel CPU
# 或
modprobe kvm-amd    # AMD CPU

# 永久加载
echo 'kvm-intel' >> /etc/modules
```

## 故障排除

### 启动问题

1. **GRUB 引导失败**
   ```bash
   # 使用救援模式修复
   grub-install /dev/sda
   update-grub
   ```

2. **网络接口不识别**
   ```bash
   # 查看网络接口
   ip link show

   # 加载网卡驱动
   modprobe [driver_name]
   ```

### 性能问题

1. **CPU 使用率过高**
   - 检查 ksoftirqd 进程
   - 优化中断处理
   - 启用硬件卸载

2. **内存不足**
   - 增加虚拟内存
   - 优化内核参数
   - 减少不必要服务

## 相关资源

- [OpenWrt x86 官方文档](https://openwrt.org/docs/guide-user/installation/openwrt_x86)
- [PVE 虚拟化文档](https://pve.proxmox.com/wiki/Main_Page)
- [恩山无线论坛 x86 板块](https://www.right.com.cn/forum/forum-158-1.html)